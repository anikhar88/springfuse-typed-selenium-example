/*
 * (c) Copyright 2005-2013 JAXIO, http://www.jaxio.com
 * Source code generated by Celerio, a Jaxio product
 * Want to purchase Celerio ? email us at info@jaxio.com
 * Follow us on twitter: @springfuse
 * Documentation: http://www.jaxio.com/documentation/celerio/
 * Template pack-selenium-primefaces:src/test/java/selenium/support/WebClientRule.p.vm.java
 */
package fr.vendredi.web.selenium.support;

import static com.google.common.base.Preconditions.checkState;
import static fr.vendredi.web.selenium.support.WebClient.WebClientBuilder.newWebClient;
import static java.lang.Boolean.parseBoolean;
import static java.lang.Integer.parseInt;
import static java.lang.System.getProperty;
import static org.apache.commons.lang.StringUtils.removeEnd;
import static org.apache.commons.lang.StringUtils.removeStart;

import org.junit.rules.TestWatcher;
import org.junit.runner.Description;

import fr.vendredi.web.selenium.support.WebClient;
import fr.vendredi.web.selenium.support.WebClientRule;

public class WebClientRule extends TestWatcher {
    private WebClient webClient;
    private Object testInstance;
    private String webDriver = getProperty("selenium.webdriver", "firefox");
    private String httpScheme = getProperty("application.http.scheme", "http");
    private String hostname = getProperty("application.hostname", "localhost");
    private int port = parseInt(getProperty("application.port", "8080"));
    private String context = getProperty("application.contextpath", "vendredi");
    private int waitTimeInSeconds = parseInt(getProperty("selenium.waitTimeInSeconds", "4"));
    private boolean followVisually = parseBoolean(getProperty("selenium.follow.visually", "false"));

    public WebClientRule(Object testInstance) {
        this.testInstance = testInstance;
    }

    public WebClientRule withHttpScheme(String httpScheme) {
        this.httpScheme = httpScheme;
        return this;
    }

    public WebClientRule withHostname(String hostname) {
        this.hostname = hostname;
        return this;
    }

    public WebClientRule withPort(int port) {
        this.port = port;
        return this;
    }

    public WebClientRule withContext(String context) {
        this.context = context;
        return this;
    }

    public WebClientRule withWebDriver(String webDriver) {
        this.webDriver = webDriver;
        return this;
    }

    public WebClientRule withWaitTimeInSeconds(int waitTimeInSeconds) {
        this.waitTimeInSeconds = waitTimeInSeconds;
        return this;
    }

    public WebClientRule withFollowingVisually() {
        this.followVisually = true;
        return this;
    }

    public WebClientRule withoutFollowingVisually() {
        this.followVisually = false;
        return this;
    }

    @Override
    protected void starting(Description description) {
        webClient = newWebClient() //
                .baseUrl(buildBaseUrl()) //
                .webDriver(webDriver) //
                .waitTimeInSeconds(waitTimeInSeconds) //
                .followVisually(followVisually) //
                .onTest(testInstance) //
                .build();
    }

    @Override
    protected void failed(Throwable e, Description description) {
        webClient.takeScreenshot(description.getDisplayName());
    }

    @Override
    protected void finished(Description description) {
        webClient.close();
    }

    private String buildBaseUrl() {
        checkState(context != null, "You need to have application.contextpath in your properties defined");
        context = removeStart(context, "/");
        context = removeEnd(context, "/");
        String autority = httpScheme + "://" + hostname + ":" + port;
        return context.isEmpty() ? autority : autority + "/" + context;
    }

    public WebClient getWebClient() {
        return webClient;
    }
}